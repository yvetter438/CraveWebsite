<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Continue in Crave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="no-referrer">
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; margin: 0; color: #111; background: #fff; }
    @media (prefers-color-scheme: dark) { body { color: #f4f4f4; background: #0b0b0b; } .btn { background:#f4f4f4; color:#111; } .muted { color:#9aa0a6; } }
    main { max-width: 560px; margin: 64px auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 28px; }
    p { line-height: 1.6; margin: 8px 0; }
    ol { margin: 8px 0 16px 20px; }
    .btn { display: inline-block; margin-top: 16px; padding: 10px 16px; border-radius: 8px; background: #111; color: #fff; text-decoration: none; border: 0; cursor: pointer; }
    .stores { display: flex; gap: 12px; margin: 12px 0; flex-wrap: wrap; }
    .qr { display: block; margin: 16px 0; width: 240px; height: 240px; }
    .muted { margin-top: 8px; font-size: 12px; color: #666; word-break: break-all; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0; }
    .loading { text-align: center; }
    .loading p { color: #999; }
  </style>
</head>
<body>
  <main>
    <h1>Continue in Crave</h1>
    
    <div id="loading" class="loading">
      <p>Processing your request...</p>
    </div>

    <div id="mobile-msg" style="display:none">
      <p>We're opening the app. If nothing happens, tap the button below.</p>
    </div>
    
    <div id="desktop-msg" style="display:none">
      <p>Open this link on your phone where the Crave app is installed.</p>
      <ol>
        <li>Scan the QR code below with your phone's camera.</li>
        <li>Or open this email on your phone and tap the button again.</li>
      </ol>
      <img id="qr" alt="QR code to open Crave" class="qr" />
      <div class="stores">
        <a href="https://apps.apple.com/us/app/crave-discover-eat-share/id6740149234" target="_blank" rel="noopener" class="btn">Get on iOS</a>
      </div>
    </div>

    <a id="open-btn" class="btn" href="#" style="display:none">Open in App</a>
    <p id="deeplink" class="muted" aria-live="polite"></p>

    <script>
      (async function () {
        // Initialize Supabase client
        const supabaseUrl = 'https://idcjvxdjqgjihnxtsiiz.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkY2p2eGRqcWdqaWhueHRzaWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUxMDM0MDEsImV4cCI6MjA1MDY3OTQwMX0.n5waj8HHbnJhblpTw-eN6xwjD_3dOQbYbiRWOMRNMfM';
        
        // Wait for Supabase library to load
        const waitForSupabase = () => {
          return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 20; // Wait up to 2 seconds
            const checkInterval = setInterval(() => {
              attempts++;
              if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
                clearInterval(checkInterval);
                resolve(true);
              } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                resolve(false);
              }
            }, 100);
          });
        };
        
        const supabaseLoaded = await waitForSupabase();
        let supabaseClient = null;
        
        if (supabaseLoaded) {
          try {
            supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
              auth: {
                detectSessionInUrl: true,
                flowType: 'pkce'
              }
            });
            console.log('‚úÖ Supabase client initialized');
          } catch (e) {
            console.error('‚ùå Supabase client initialization failed:', e);
          }
        } else {
          console.warn('‚ö†Ô∏è Supabase client not loaded - will pass code directly');
        }

        // Parse URL parameters
        function parseParams() {
          try {
            var search = new URLSearchParams(window.location.search || "");
            var hash = new URLSearchParams((window.location.hash || "").replace(/^#/, ""));
            
            return {
              code: search.get("code") || hash.get("code"),
              token: search.get("token") || hash.get("token"),
              access_token: search.get("access_token") || hash.get("access_token"),
              refresh_token: search.get("refresh_token") || hash.get("refresh_token"),
              type: search.get("type") || hash.get("type"),
              target: search.get("target") || null,
              redirect_to: search.get("redirect_to") || null
            };
          } catch (e) {
            return {
              code: null,
              token: null,
              access_token: null,
              refresh_token: null,
              type: null,
              target: null,
              redirect_to: null
            };
          }
        }

        function determineTarget(params) {
          if (params.type === "recovery") {
            return "reset-password";
          }
          if (params.code && !params.type) {
            return "reset-password";
          }
          if (params.redirect_to && params.redirect_to.startsWith("crave://")) {
            var path = params.redirect_to.replace(/^crave:\/\//, "").split("?")[0].split("#")[0];
            if (path && path.trim()) {
              return path;
            }
          }
          if (params.target) {
            return params.target;
          }
          return "login";
        }

        var params = parseParams();

        // Debug logging
        console.log("üîç ========================================");
        console.log("üîç Website URL:", window.location.href);
        console.log("üîç Has code:", !!params.code);
        console.log("üîç Has token:", !!params.token);
        console.log("üîç Has access_token:", !!params.access_token);
        console.log("üîç Type:", params.type || "none");
        console.log("üîç ========================================");

        var ua = (navigator.userAgent || "").toLowerCase();
        var isMobile = /iphone|ipad|ipod|android/.test(ua);

        var loadingEl = document.getElementById("loading");
        var mobileMsg = document.getElementById("mobile-msg");
        var desktopMsg = document.getElementById("desktop-msg");
        var openBtn = document.getElementById("open-btn");
        var deeplinkEl = document.getElementById("deeplink");
        var qr = document.getElementById("qr");

        var target = determineTarget(params);
        var deepLink = "crave://" + target;
        var queryParams = [];
        
        // CRITICAL: Try to exchange code for session tokens
        if (params.code && supabaseClient) {
          console.log("üîë Attempting to exchange PKCE code for session tokens...");
          console.log("üîë Code:", params.code.substring(0, 20) + "...");
          
          try {
            // Try Supabase's automatic session detection from URL
            console.log("üîë Attempting automatic session detection from URL...");
            const { data: urlSessionData, error: urlError } = await supabaseClient.auth.getSessionFromUrl({ 
              storeSession: false 
            });
            
            if (urlSessionData && urlSessionData.session && !urlError) {
              console.log("‚úÖ Got session from URL automatically!");
              queryParams.push("access_token=" + encodeURIComponent(urlSessionData.session.access_token));
              queryParams.push("refresh_token=" + encodeURIComponent(urlSessionData.session.refresh_token));
              if (params.type) {
                queryParams.push("type=" + encodeURIComponent(params.type));
              } else {
                queryParams.push("type=recovery");
              }
              console.log("‚úÖ Passing session tokens to app");
            } else {
              // Try manual exchange
              console.log("üîë Automatic detection failed, trying manual code exchange...");
              const { data: exchangeData, error: exchangeError } = await supabaseClient.auth.exchangeCodeForSession(params.code);
              
              if (exchangeError) {
                console.error("‚ùå Code exchange failed:", exchangeError);
                console.error("‚ùå Error:", exchangeError.message);
                console.error("‚ùå This likely means PKCE verifier is not in browser storage");
                console.error("‚ùå Verifier is probably stored in the mobile app that initiated reset");
                
                // Pass code to app - it will try to exchange but will likely fail
                queryParams.push("code=" + encodeURIComponent(params.code));
                if (params.type) {
                  queryParams.push("type=" + encodeURIComponent(params.type));
                } else {
                  queryParams.push("type=recovery");
                }
                console.log("‚ö†Ô∏è Passing code to app - app exchange will likely fail (bad_code_verifier)");
              } else if (exchangeData && exchangeData.session) {
                console.log("‚úÖ Code exchanged successfully!");
                queryParams.push("access_token=" + encodeURIComponent(exchangeData.session.access_token));
                queryParams.push("refresh_token=" + encodeURIComponent(exchangeData.session.refresh_token));
                if (params.type) {
                  queryParams.push("type=" + encodeURIComponent(params.type));
                } else {
                  queryParams.push("type=recovery");
                }
                console.log("‚úÖ Passing session tokens to app");
              } else {
                console.warn("‚ö†Ô∏è Exchange succeeded but no session returned");
                // Fallback to passing code
                queryParams.push("code=" + encodeURIComponent(params.code));
                if (params.type) {
                  queryParams.push("type=" + encodeURIComponent(params.type));
                } else {
                  queryParams.push("type=recovery");
                }
              }
            }
          } catch (e) {
            console.error("‚ùå Error during code exchange:", e);
            // Fallback: pass code
            queryParams.push("code=" + encodeURIComponent(params.code));
            if (params.type) {
              queryParams.push("type=" + encodeURIComponent(params.type));
            } else {
              queryParams.push("type=recovery");
            }
            console.log("‚ö†Ô∏è Exception caught - passing code to app");
          }
        } else if (params.code) {
          // No Supabase client available
          console.log("‚ö†Ô∏è No Supabase client - passing code directly");
          queryParams.push("code=" + encodeURIComponent(params.code));
          queryParams.push("type=recovery");
        } else if (params.token) {
          // PKCE token (alternative flow)
          queryParams.push("token=" + encodeURIComponent(params.token));
          if (params.type) {
            queryParams.push("type=" + encodeURIComponent(params.type));
          }
        } else if (params.access_token && params.refresh_token) {
          // Already have session tokens
          queryParams.push("access_token=" + encodeURIComponent(params.access_token));
          queryParams.push("refresh_token=" + encodeURIComponent(params.refresh_token));
          if (params.type) {
            queryParams.push("type=" + encodeURIComponent(params.type));
          }
        }
        
        if (queryParams.length > 0) {
          deepLink += "?" + queryParams.join("&");
        }

        console.log("üîç Final deep link:", deepLink);

        if (loadingEl) loadingEl.style.display = "none";
        if (openBtn) {
          openBtn.setAttribute("href", deepLink);
          openBtn.onclick = function (e) { 
            e.preventDefault(); 
            window.location.href = deepLink; 
          };
          openBtn.style.display = "inline-block";
        }

        if (isMobile) {
          if (mobileMsg) mobileMsg.style.display = "block";
          if (deeplinkEl) deeplinkEl.textContent = "Deep link: " + deepLink;
          setTimeout(function () { 
            window.location.href = deepLink; 
          }, 250);
        } else {
          if (desktopMsg) desktopMsg.style.display = "block";
          var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(deepLink);
          if (qr) qr.src = qrUrl;
          if (deeplinkEl) deeplinkEl.textContent = "Deep link: " + deepLink;
        }
      })();
    </script>
  </main>
</body>
</html>
