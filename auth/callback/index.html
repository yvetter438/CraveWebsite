<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Continue in Crave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="no-referrer">
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; margin: 0; color: #111; background: #fff; }
    @media (prefers-color-scheme: dark) { body { color: #f4f4f4; background: #0b0b0b; } .btn { background:#f4f4f4; color:#111; } .muted { color:#9aa0a6; } }
    main { max-width: 560px; margin: 64px auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 28px; }
    p { line-height: 1.6; margin: 8px 0; }
    ol { margin: 8px 0 16px 20px; }
    .btn { display: inline-block; margin-top: 16px; padding: 10px 16px; border-radius: 8px; background: #111; color: #fff; text-decoration: none; border: 0; cursor: pointer; }
    .stores { display: flex; gap: 12px; margin: 12px 0; flex-wrap: wrap; }
    .qr { display: block; margin: 16px 0; width: 240px; height: 240px; }
    .muted { margin-top: 8px; font-size: 12px; color: #666; word-break: break-all; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0; }
    .loading { text-align: center; }
    .loading p { color: #999; }
  </style>
</head>
<body>
  <main>
    <h1>Continue in Crave</h1>
    
    <div id="loading" class="loading">
      <p>Processing your request...</p>
    </div>

    <div id="mobile-msg" style="display:none">
      <p>We're opening the app. If nothing happens, tap the button below.</p>
    </div>
    
    <div id="desktop-msg" style="display:none">
      <p>Open this link on your phone where the Crave app is installed.</p>
      <ol>
        <li>Scan the QR code below with your phone's camera.</li>
        <li>Or open this email on your phone and tap the button again.</li>
      </ol>
      <img id="qr" alt="QR code to open Crave" class="qr" />
      <div class="stores">
        <a href="https://apps.apple.com/us/app/crave-discover-eat-share/id6740149234" target="_blank" rel="noopener" class="btn">Get on iOS</a>
      </div>
    </div>

    <a id="open-btn" class="btn" href="#" style="display:none">Open in App</a>
    <p id="deeplink" class="muted" aria-live="polite"></p>

    <script>
      (async function () {
        // Initialize Supabase client (UPDATE THESE VALUES WITH YOUR SUPABASE CREDENTIALS)
        const supabaseUrl = 'https://idcjvxdjqgjihnxtsiiz.supabase.co'; // TODO: Replace with your Supabase URL
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkY2p2eGRqcWdqaWhueHRzaWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUxMDM0MDEsImV4cCI6MjA1MDY3OTQwMX0.n5waj8HHbnJhblpTw-eN6xwjD_3dOQbYbiRWOMRNMfM'; // TODO: Replace with your Supabase anon key
        
        // Wait for Supabase to load (with timeout)
        const waitForSupabase = () => {
          return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 10; // Wait up to 1 second (10 * 100ms)
            const checkInterval = setInterval(() => {
              attempts++;
              if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                clearInterval(checkInterval);
                resolve(true);
              } else if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
                clearInterval(checkInterval);
                resolve(true);
              } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                resolve(false);
              }
            }, 100);
          });
        };
        
        // Wait for Supabase library to be available
        const supabaseLoaded = await waitForSupabase();
        
        // Initialize Supabase client
        let supabaseClient = null;
        if (supabaseLoaded) {
          try {
            // Supabase CDN loads as global 'supabase' object with createClient method
            if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
              supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
            } else if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
              supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            }
            console.log('‚úÖ Supabase client initialized');
          } catch (e) {
            console.error('‚ö†Ô∏è Supabase client initialization failed:', e);
          }
        } else {
          console.warn('‚ö†Ô∏è Supabase client not available after waiting, will pass code directly');
          console.warn('‚ö†Ô∏è Make sure Supabase JS library is loaded from CDN and anon key is set');
        }

        // Parse URL parameters from both query string and hash
        function parseParams() {
          try {
            var search = new URLSearchParams(window.location.search || "");
            var hash = new URLSearchParams((window.location.hash || "").replace(/^#/, ""));
            
            return {
              search: search,
              hash: hash,
              // PKCE authorization code (from Supabase redirect)
              code: search.get("code") || hash.get("code"),
              // Supabase auth params - PKCE token (for recovery, signup, etc)
              token: search.get("token") || hash.get("token"),
              // Session tokens (if available)
              access_token: search.get("access_token") || hash.get("access_token"),
              refresh_token: search.get("refresh_token") || hash.get("refresh_token"),
              token_type: search.get("token_type") || hash.get("token_type"),
              type: search.get("type") || hash.get("type"), // 'signup', 'recovery', etc
              // Custom params
              target: search.get("target") || null,
              redirect_to: search.get("redirect_to") || null
            };
          } catch (e) {
            return {
              search: new URLSearchParams(),
              hash: new URLSearchParams(),
              code: null,
              target: null,
              redirect_to: null,
              token: null,
              access_token: null,
              refresh_token: null,
              token_type: null,
              type: null
            };
          }
        }

        function determineTarget(params) {
          // CRITICAL: If we have a code (PKCE flow), this is likely from a password reset
          // Default to reset-password if we have code but no explicit type
          if (params.code && !params.type) {
            return "reset-password";
          }

          // Check recovery type FIRST (password reset)
          if (params.type === "recovery") {
            return "reset-password";
          }

          // If redirect_to is provided (from Supabase), use it
          if (params.redirect_to) {
            // If it's already a deep link, extract the path
            if (params.redirect_to.startsWith("crave://")) {
              var path = params.redirect_to.replace(/^crave:\/\//, "");
              // Remove query params and hash if present
              path = path.split("?")[0].split("#")[0];
              // If path is empty or just whitespace, treat it as no specific redirect
              if (path && path.trim()) {
                return path;
              }
            }
            // If it's a web URL, extract the path or treat as generic redirect
            try {
              var url = new URL(params.redirect_to);
              // For web redirects, we'll still route to login by default
            } catch (e) {}
          }

          // Use custom target if provided
          if (params.target) {
            return params.target;
          }

          // Default to login (including signup confirmation)
          return "login";
        }

        var params = parseParams();

        // üîç DEBUG SECTION - Log all received parameters
        console.log("üîç ========================================");
        console.log("üîç Website received URL:", window.location.href);
        console.log("üîç Full URL:", window.location.href);
        console.log("üîç Search params:", window.location.search);
        console.log("üîç Hash params:", window.location.hash);
        console.log("üîç Parsed params:", {
          code: params.code ? params.code.substring(0, 20) + "..." : "‚ùå MISSING",
          token: params.token ? params.token.substring(0, 20) + "..." : "‚ùå MISSING",
          type: params.type || "‚ùå MISSING",
          access_token: params.access_token ? "‚úÖ Present" : "‚ùå MISSING",
          refresh_token: params.refresh_token ? "‚úÖ Present" : "‚ùå MISSING",
          redirect_to: params.redirect_to || "‚ùå MISSING",
          target: params.target || "‚ùå MISSING"
        });
        console.log("üîç ========================================");

        var ua = (navigator.userAgent || "").toLowerCase();
        var isMobile = /iphone|ipad|ipod|android/.test(ua);

        var loadingEl = document.getElementById("loading");
        var mobileMsg = document.getElementById("mobile-msg");
        var desktopMsg = document.getElementById("desktop-msg");
        var openBtn = document.getElementById("open-btn");
        var deeplinkEl = document.getElementById("deeplink");
        var qr = document.getElementById("qr");

        // Determine the target screen
        var target = determineTarget(params);

        // Build deep link - start with target
        var deepLink = "crave://" + target;
        
        // Build query parameters as direct params (not base64 JSON)
        var queryParams = [];
        
        // CRITICAL: If we have a code (PKCE authorization code), exchange it for session tokens
        if (params.code && supabaseClient) {
          console.log("üîë Exchanging PKCE code for session tokens...");
          try {
            const { data, error } = await supabaseClient.auth.exchangeCodeForSession(params.code);
            
            if (error) {
              console.error("‚ùå Code exchange failed:", error);
              // Fallback: pass code and let app try (though it might fail)
              queryParams.push("code=" + encodeURIComponent(params.code));
              if (params.type) {
                queryParams.push("type=" + encodeURIComponent(params.type));
              } else {
                queryParams.push("type=recovery");
              }
              console.log("‚ö†Ô∏è Passing code directly to app (exchange failed)");
            } else if (data && data.session) {
              console.log("‚úÖ Code exchanged successfully, got session tokens");
              // Pass session tokens to app instead of code
              queryParams.push("access_token=" + encodeURIComponent(data.session.access_token));
              queryParams.push("refresh_token=" + encodeURIComponent(data.session.refresh_token));
              if (params.type) {
                queryParams.push("type=" + encodeURIComponent(params.type));
              } else {
                queryParams.push("type=recovery"); // Password reset
              }
              console.log("‚úÖ Passing session tokens to app");
            } else {
              console.warn("‚ö†Ô∏è Code exchange returned no session data");
              // Fallback to code
              queryParams.push("code=" + encodeURIComponent(params.code));
              queryParams.push("type=recovery");
            }
          } catch (e) {
            console.error("‚ùå Error exchanging code:", e);
            // Fallback: pass code anyway
            queryParams.push("code=" + encodeURIComponent(params.code));
            queryParams.push("type=recovery");
          }
        } else if (params.code) {
          // No Supabase client available, pass code (will likely fail but worth trying)
          console.log("‚ö†Ô∏è No Supabase client, passing code directly (may fail)");
          queryParams.push("code=" + encodeURIComponent(params.code));
          queryParams.push("type=recovery");
        } else if (params.token) {
          // PKCE token (alternative flow)
          queryParams.push("token=" + encodeURIComponent(params.token));
          if (params.type) {
            queryParams.push("type=" + encodeURIComponent(params.type));
          }
        } else if (params.access_token && params.refresh_token) {
          // Already have session tokens
          queryParams.push("access_token=" + encodeURIComponent(params.access_token));
          queryParams.push("refresh_token=" + encodeURIComponent(params.refresh_token));
          if (params.type) {
            queryParams.push("type=" + encodeURIComponent(params.type));
          }
        }
        
        // Append query string if we have params
        if (queryParams.length > 0) {
          deepLink += "?" + queryParams.join("&");
        }

        // üîç DEBUG: Log final deep link and routing decision
        console.log("üîç ========================================");
        console.log("üîç Routing decision:");
        console.log("üîç   Target screen:", target);
        console.log("üîç   Query params added:", queryParams.length);
        console.log("üîç   Final deep link:", deepLink);
        console.log("üîç ========================================");

        // Show the appropriate message based on device
        if (loadingEl) loadingEl.style.display = "none";
        if (openBtn) {
          openBtn.setAttribute("href", deepLink);
          openBtn.onclick = function (e) { 
            e.preventDefault(); 
            window.location.href = deepLink; 
          };
          openBtn.style.display = "inline-block";
        }

        if (isMobile) {
          // Mobile: show message and try to open app
          if (mobileMsg) mobileMsg.style.display = "block";
          if (deeplinkEl) deeplinkEl.textContent = "Deep link: " + deepLink;
          // Allow initial render, then attempt to open the app
          setTimeout(function () { 
            window.location.href = deepLink; 
          }, 250);
        } else {
          // Desktop: show QR code
          if (desktopMsg) desktopMsg.style.display = "block";
          var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(deepLink);
          if (qr) qr.src = qrUrl;
          if (deeplinkEl) deeplinkEl.textContent = "Deep link: " + deepLink;
        }
      })();
    </script>
  </main>
</body>
</html>


