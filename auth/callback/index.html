<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Continue in Crave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="no-referrer">
  <meta name="color-scheme" content="light dark">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; margin: 0; color: #111; background: #fff; }
    @media (prefers-color-scheme: dark) { body { color: #f4f4f4; background: #0b0b0b; } .btn { background:#f4f4f4; color:#111; } .muted { color:#9aa0a6; } }
    main { max-width: 560px; margin: 64px auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 28px; }
    p { line-height: 1.6; margin: 8px 0; }
    ol { margin: 8px 0 16px 20px; }
    .btn { display: inline-block; margin-top: 16px; padding: 10px 16px; border-radius: 8px; background: #111; color: #fff; text-decoration: none; border: 0; cursor: pointer; }
    .stores { display: flex; gap: 12px; margin: 12px 0; flex-wrap: wrap; }
    .qr { display: block; margin: 16px 0; width: 240px; height: 240px; }
    .muted { margin-top: 8px; font-size: 12px; color: #666; word-break: break-all; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0; }
    .loading { text-align: center; }
    .loading p { color: #999; }
  </style>
</head>
<body>
  <main>
    <h1>Continue in Crave</h1>
    
    <div id="loading" class="loading">
      <p>Processing your request...</p>
    </div>

    <div id="mobile-msg" style="display:none">
      <p>We're opening the app. If nothing happens, tap the button below.</p>
    </div>
    
    <div id="desktop-msg" style="display:none">
      <p>Open this link on your phone where the Crave app is installed.</p>
      <ol>
        <li>Scan the QR code below with your phone's camera.</li>
        <li>Or open this email on your phone and tap the button again.</li>
      </ol>
      <img id="qr" alt="QR code to open Crave" class="qr" />
      <div class="stores">
        <a href="https://apps.apple.com/us/app/crave-discover-eat-share/id6740149234" target="_blank" rel="noopener" class="btn">Get on iOS</a>
      </div>
    </div>

    <a id="open-btn" class="btn" href="#" style="display:none">Open in App</a>
    <p id="deeplink" class="muted" aria-live="polite"></p>

    <script>
      (function () {
        // Parse URL parameters from both query string and hash
        function parseParams() {
          try {
            var search = new URLSearchParams(window.location.search || "");
            var hash = new URLSearchParams((window.location.hash || "").replace(/^#/, ""));
            
            return {
              search: search,
              hash: hash,
              // PKCE authorization code (from Supabase redirect)
              code: search.get("code") || hash.get("code"),
              // Supabase auth params - PKCE token (for recovery, signup, etc)
              token: search.get("token") || hash.get("token"),
              // Session tokens (if available)
              access_token: search.get("access_token") || hash.get("access_token"),
              refresh_token: search.get("refresh_token") || hash.get("refresh_token"),
              token_type: search.get("token_type") || hash.get("token_type"),
              type: search.get("type") || hash.get("type"), // 'signup', 'recovery', etc
              // Custom params
              target: search.get("target") || null,
              redirect_to: search.get("redirect_to") || null
            };
          } catch (e) {
            return {
              search: new URLSearchParams(),
              hash: new URLSearchParams(),
              code: null,
              target: null,
              redirect_to: null,
              token: null,
              access_token: null,
              refresh_token: null,
              token_type: null,
              type: null
            };
          }
        }

        function determineTarget(params) {
          // CRITICAL: If we have a code (PKCE flow), this is likely from a password reset
          // Default to reset-password if we have code but no explicit type
          if (params.code && !params.type) {
            return "reset-password";
          }

          // Check recovery type FIRST (password reset)
          if (params.type === "recovery") {
            return "reset-password";
          }

          // If redirect_to is provided (from Supabase), use it
          if (params.redirect_to) {
            // If it's already a deep link, extract the path
            if (params.redirect_to.startsWith("crave://")) {
              var path = params.redirect_to.replace(/^crave:\/\//, "");
              // Remove query params and hash if present
              path = path.split("?")[0].split("#")[0];
              // If path is empty or just whitespace, treat it as no specific redirect
              if (path && path.trim()) {
                return path;
              }
            }
            // If it's a web URL, extract the path or treat as generic redirect
            try {
              var url = new URL(params.redirect_to);
              // For web redirects, we'll still route to login by default
            } catch (e) {}
          }

          // Use custom target if provided
          if (params.target) {
            return params.target;
          }

          // Default to login (including signup confirmation)
          return "login";
        }

        var params = parseParams();

        // üîç DEBUG SECTION - Log all received parameters
        console.log("üîç ========================================");
        console.log("üîç Website received URL:", window.location.href);
        console.log("üîç Full URL:", window.location.href);
        console.log("üîç Search params:", window.location.search);
        console.log("üîç Hash params:", window.location.hash);
        console.log("üîç Parsed params:", {
          code: params.code ? params.code.substring(0, 20) + "..." : "‚ùå MISSING",
          token: params.token ? params.token.substring(0, 20) + "..." : "‚ùå MISSING",
          type: params.type || "‚ùå MISSING",
          access_token: params.access_token ? "‚úÖ Present" : "‚ùå MISSING",
          refresh_token: params.refresh_token ? "‚úÖ Present" : "‚ùå MISSING",
          redirect_to: params.redirect_to || "‚ùå MISSING",
          target: params.target || "‚ùå MISSING"
        });
        console.log("üîç ========================================");

        var ua = (navigator.userAgent || "").toLowerCase();
        var isMobile = /iphone|ipad|ipod|android/.test(ua);

        var loadingEl = document.getElementById("loading");
        var mobileMsg = document.getElementById("mobile-msg");
        var desktopMsg = document.getElementById("desktop-msg");
        var openBtn = document.getElementById("open-btn");
        var deeplinkEl = document.getElementById("deeplink");
        var qr = document.getElementById("qr");

        // Determine the target screen
        var target = determineTarget(params);

        // Build deep link - start with target
        var deepLink = "crave://" + target;
        
        // Build query parameters as direct params (not base64 JSON)
        var queryParams = [];
        
        // CRITICAL: If we have a code (PKCE authorization code), use that FIRST
        if (params.code) {
          queryParams.push("code=" + encodeURIComponent(params.code));
          // Infer type from context - if we got a code from password reset flow, it's recovery
          if (!params.type) {
            queryParams.push("type=recovery"); // Default for password reset flow
            console.log("‚úÖ Using PKCE code flow for password reset");
          } else {
            queryParams.push("type=" + encodeURIComponent(params.type));
          }
        }
        
        // Add PKCE token if available (alternative flow)
        if (params.token) {
          queryParams.push("token=" + encodeURIComponent(params.token));
        }
        
        // Add type if explicitly provided (but don't override if we already added it from code)
        if (params.type && !params.code) {
          queryParams.push("type=" + encodeURIComponent(params.type));
        }
        
        // Add session tokens if available (alternative auth flow)
        if (params.access_token) {
          queryParams.push("access_token=" + encodeURIComponent(params.access_token));
        }
        if (params.refresh_token) {
          queryParams.push("refresh_token=" + encodeURIComponent(params.refresh_token));
        }
        
        // Append query string if we have params
        if (queryParams.length > 0) {
          deepLink += "?" + queryParams.join("&");
        }

        // üîç DEBUG: Log final deep link and routing decision
        console.log("üîç ========================================");
        console.log("üîç Routing decision:");
        console.log("üîç   Target screen:", target);
        console.log("üîç   Query params added:", queryParams.length);
        console.log("üîç   Final deep link:", deepLink);
        console.log("üîç ========================================");

        // Show the appropriate message based on device
        if (loadingEl) loadingEl.style.display = "none";
        if (openBtn) {
          openBtn.setAttribute("href", deepLink);
          openBtn.onclick = function (e) { 
            e.preventDefault(); 
            window.location.href = deepLink; 
          };
          openBtn.style.display = "inline-block";
        }

        if (isMobile) {
          // Mobile: show message and try to open app
          if (mobileMsg) mobileMsg.style.display = "block";
          if (deeplinkEl) deeplinkEl.textContent = "Deep link: " + deepLink;
          // Allow initial render, then attempt to open the app
          setTimeout(function () { 
            window.location.href = deepLink; 
          }, 250);
        } else {
          // Desktop: show QR code
          if (desktopMsg) desktopMsg.style.display = "block";
          var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(deepLink);
          if (qr) qr.src = qrUrl;
          if (deeplinkEl) deeplinkEl.textContent = "Deep link: " + deepLink;
        }
      })();
    </script>
  </main>
</body>
</html>


